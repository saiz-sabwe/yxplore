{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock title%}
{% block extra_css %}{% endblock extra_css%}

{% block extra_javascript %}
<script src="{% static 'ModuleProfils/js/kyc.js' %}"></script>
{% endblock extra_javascript%}

{% block content %}
<!-- =======================
Page Banner START -->
<section class="pt-4 pt-md-5 pb-0">
	<div class="container">
		<div class="row">
			<div class="col-12 mx-auto text-center">
				<h1 class="fs-2 mb-2">Validation KYC Client</h1>
				<p class="mb-0">Complétez votre profil pour une validation rapide de votre identité.</p>
			</div>
		</div>
	</div>
</section>
<!-- =======================
Page Banner END -->

<!-- =======================
Main content START -->
<section>
	<div class="container">
		<div class="row">
			<div class="col-lg-10 mx-auto">
				<!-- KYC Status Card -->
				<div class="card shadow mb-4">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0">
							<i class="bi bi-shield-check me-2"></i>
							Statut KYC: 
							<span class="badge bg-light text-dark">
								{% if profile.kyc_status == 0 %}En attente{% endif %}
								{% if profile.kyc_status == 1 %}KYC1 Approuvé{% endif %}
								{% if profile.kyc_status == 2 %}KYC2 Approuvé{% endif %}
								{% if profile.kyc_status == 3 %}Rejeté{% endif %}
							</span>
						</h5>
					</div>
					<div class="card-body">
						<div class="row align-items-center">
							<div class="col-md-8">
								<div class="progress mb-2" style="height: 10px;">
									<div class="progress-bar bg-success" role="progressbar" 
										 style="width: {{ profile.get_kyc_completion_percentage }}%" 
										 aria-valuenow="{{ profile.get_kyc_completion_percentage }}" 
										 aria-valuemin="0" aria-valuemax="100"></div>
								</div>
								<small class="text-muted">{{ profile.get_kyc_completion_percentage }}% complété</small>
							</div>
							<div class="col-md-4 text-end">
								{% if profile.kyc_status == 0 %}
									<span class="badge bg-warning">En attente de validation</span>
								{% elif profile.kyc_status == 1 %}
									<span class="badge bg-success">Niveau 1 validé</span>
								{% elif profile.kyc_status == 2 %}
									<span class="badge bg-success">Niveau 2 validé</span>
								{% elif profile.kyc_status == 3 %}
									<span class="badge bg-danger">Rejeté</span>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<form class="vstack gap-4" id="kycClientForm" enctype="multipart/form-data">
					{% csrf_token %}
					<input type="hidden" name="profile_type" value="client">
					<input type="hidden" name="op" value="submit_kyc">

					<!-- Personal Information START -->
					<div class="card shadow">
						<div class="card-header border-bottom">
							<h5 class="mb-0">
								<i class="bi bi-person-circle me-2"></i>
								Informations Personnelles
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<!-- First Name -->
								<div class="col-md-6">
									<label class="form-label">Prénom *</label>
									<input type="text" class="form-control" name="prenom" 
										   value="{{ profile.prenom|default:'' }}" 
										   placeholder="Votre prénom" required>
								</div>

								<!-- Last Name -->
								<div class="col-md-6">
									<label class="form-label">Nom *</label>
									<input type="text" class="form-control" name="nom" 
										   value="{{ profile.nom|default:'' }}" 
										   placeholder="Votre nom" required>
								</div>

								<!-- Phone -->
								<div class="col-md-6">
									<label class="form-label">Téléphone *</label>
									<input type="tel" class="form-control" name="phone" 
										   value="{{ profile.phone|default:'' }}" 
										   placeholder="+33 6 12 34 56 78" required>
								</div>

								<!-- Birth Date -->
								<div class="col-md-6">
									<label class="form-label">Date de naissance *</label>
									<input type="date" class="form-control" name="birth_date" 
										   value="{{ profile.birth_date|date:'Y-m-d'|default:'' }}" 
										   required>
								</div>

								<!-- Nationality -->
								<div class="col-md-6">
									<label class="form-label">Nationalité *</label>
									<select class="form-select" name="nationality" required>
										<option value="">Sélectionnez votre nationalité</option>
										<option value="FR" {% if profile.nationality == 'FR' %}selected{% endif %}>Française</option>
										<option value="BE" {% if profile.nationality == 'BE' %}selected{% endif %}>Belge</option>
										<option value="CH" {% if profile.nationality == 'CH' %}selected{% endif %}>Suisse</option>
										<option value="CA" {% if profile.nationality == 'CA' %}selected{% endif %}>Canadienne</option>
										<option value="MA" {% if profile.nationality == 'MA' %}selected{% endif %}>Marocaine</option>
										<option value="TN" {% if profile.nationality == 'TN' %}selected{% endif %}>Tunisienne</option>
										<option value="DZ" {% if profile.nationality == 'DZ' %}selected{% endif %}>Algérienne</option>
										<option value="OTHER" {% if profile.nationality and profile.nationality not in 'FR,BE,CH,CA,MA,TN,DZ' %}selected{% endif %}>Autre</option>
									</select>
								</div>

								<!-- Address -->
								<div class="col-12">
									<label class="form-label">Adresse complète *</label>
									<textarea class="form-control" name="address" rows="3" 
											  placeholder="Votre adresse complète" required>{{ profile.address|default:'' }}</textarea>
								</div>
							</div>
						</div>
					</div>
					<!-- Personal Information END -->

					<!-- Identity Document START -->
					<div class="card shadow">
						<div class="card-header border-bottom">
							<h5 class="mb-0">
								<i class="bi bi-file-earmark-text me-2"></i>
								Document d'Identité
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<!-- Document Upload -->
								<div class="col-12">
									<label class="form-label">Document d'identité *</label>
									<div class="dropzone dropzone-custom" id="idDocumentDropzone" 
										 data-dropzone='{"maxFiles": 1, "addRemoveLinks": true, "acceptedFiles": ".pdf,.jpg,.jpeg,.png"}'>
										<div class="dz-message needsclick">
											<i class="bi bi-upload display-4 text-primary"></i>
											<p class="mb-2">Glissez votre document ici ou cliquez pour sélectionner</p>
											<p class="small text-muted mb-0">Formats acceptés: PDF, JPG, JPEG, PNG</p>
										</div>
									</div>
									{% if profile.document %}
									<div class="mt-3">
										<div class="alert alert-info">
											<i class="bi bi-file-earmark-text me-2"></i>
											Document actuel: <a href="{{ profile.document.url }}" target="_blank">{{ profile.document.name|slice:"19:" }}</a>
										</div>
									</div>
									{% endif %}
									<p class="small mb-0 mt-2">
										<b>Note:</b> Votre document d'identité sera utilisé uniquement pour la vérification KYC et sera traité de manière sécurisée.
									</p>
								</div>
							</div>
						</div>
					</div>
					<!-- Identity Document END -->

					<!-- Missing Fields Alert -->
					{% if profile.get_missing_kyc_fields %}
					<div class="alert alert-warning">
						<h6 class="alert-heading">
							<i class="bi bi-exclamation-triangle me-2"></i>
							Champs manquants pour la validation KYC
						</h6>
						<ul class="mb-0">
							{% for field in profile.get_missing_kyc_fields %}
							<li>{{ field }}</li>
							{% endfor %}
						</ul>
					</div>
					{% endif %}

					<!-- Submit Button -->
					<div class="text-end">
						<button type="button" class="btn btn-primary btn-lg" id="submitKYCClientBtn">
							<i class="bi bi-check-circle me-2"></i>
							Soumettre pour validation KYC
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</section>
<!-- =======================
Main content END -->
{% endblock content %}

{% block param %} {% endblock param %}

{% block javascript %}{% endblock javascript%}